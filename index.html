<body>

<header>
    <img src="The U Transparent - Trademark.png" alt="Company Logo" class="logo-img">
    <h1 style="font-size: 1.5rem; margin-top: 0;">Staff Certification Portal</h1>
    <p style="text-transform: uppercase; font-size: 0.8rem; letter-spacing: 2px; color: var(--brand-grey);">Pain-Free Performance System</p>
</header>

<div class="container">
    
    <div id="login-view" class="card">
        <h2 style="margin-top:0;">Coach Login</h2>
        <p style="color:var(--brand-grey); margin-bottom:30px;">Initializing system database...</p>
        <div id="loader" style="text-align:center; margin-bottom:20px;">LOADING EXAM DATA...</div>
        
        <div id="login-form" class="hidden">
            <label for="username">Full Name</label>
            <input type="text" id="username" placeholder="Enter your full name">
            <button class="btn" onclick="login()">Enter Portal</button>
        </div>
    </div>

    <div id="dashboard-view" class="card hidden">
        <h2 style="margin-top:0;">Active Modules</h2>
        <p style="margin-bottom: 30px;">Select a module to begin testing.</p>
        <div id="module-list"></div> </div>

    <div id="quiz-view" class="card hidden">
        <div class="quiz-header">
            <h2 id="quiz-title" style="margin:0;">Module</h2>
        </div>
        <div id="quiz-container"></div>
        <button id="submit-btn" class="btn" onclick="gradeQuiz()">Submit Assessment</button>
    </div>

    <div id="results-view" class="card hidden">
        <div id="score-circle" class="score-circle">0%</div>
        <div id="result-message"></div>
        <button class="btn btn-secondary" onclick="location.reload()">Return to Dashboard</button>
    </div>

</div>

<script>
    // *** PASTE YOUR NEW GOOGLE SCRIPT URL HERE ***
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbx7lAJd7WuZHcu6GeQUyVsMqidJiQd6mtq3Ivq9b5_hX7ljz4s_-upjGwnyflnyQqBNyQ/exec";

    let db = {}; // Will be populated from Google Sheet
    let user = "";
    let activeModule = "";

    // Initialize: Fetch Questions immediately on load
    window.onload = function() {
        fetch(SCRIPT_URL + "?action=getQuestions")
        .then(response => response.json())
        .then(data => {
            db = data;
            document.getElementById("loader").classList.add("hidden");
            document.getElementById("login-form").classList.remove("hidden");
            generateModuleButtons();
        })
        .catch(error => {
            document.getElementById("loader").innerText = "Error loading database. Check internet connection.";
        });
    };

    function generateModuleButtons() {
        const list = document.getElementById("module-list");
        list.innerHTML = "";
        
        // Dynamically create buttons based on what is in the Sheet
        Object.keys(db).forEach(modName => {
            const btn = document.createElement("button");
            btn.className = "btn btn-module";
            btn.innerHTML = `${modName}`;
            btn.onclick = () => startQuiz(modName);
            list.appendChild(btn);
        });
    }

    function login() {
        const input = document.getElementById("username").value;
        if (!input.trim()) return alert("Please enter your name");
        user = input;
        switchView("dashboard-view");
    }

    function startQuiz(moduleName) {
        activeModule = moduleName;
        document.getElementById("quiz-title").innerText = moduleName;
        const container = document.getElementById("quiz-container");
        container.innerHTML = "";

        const questions = db[moduleName];
        
        if(!questions || questions.length === 0) {
            container.innerHTML = "<p>No questions found for this module.</p>";
            return;
        }

        questions.forEach((q, idx) => {
            let html = `
                <div class="question-block" id="q${idx}">
                    <div class="question-text">${idx + 1}. ${q.q}</div>
            `;
            q.o.forEach((opt, optIdx) => {
                html += `
                    <label class="option-label" id="lbl-${idx}-${optIdx}">
                        <input type="radio" name="q${idx}" value="${optIdx}">
                        ${opt}
                    </label>
                `;
            });
            html += `<div class="rationale" id="rat-${idx}"><strong>Rationale:</strong> ${q.r}</div></div>`;
            container.innerHTML += html;
        });

        switchView("quiz-view");
    }

    function gradeQuiz() {
        const questions = db[activeModule];
        let score = 0;
        let weakPoints = [];
        let allAnswered = true;

        questions.forEach((q, idx) => {
            const selected = document.querySelector(`input[name="q${idx}"]:checked`);
            if (!selected) {
                allAnswered = false;
                return;
            }
            
            const val = parseInt(selected.value);
            const label = document.getElementById(`lbl-${idx}-${val}`);
            
            if (val === q.a) {
                score++;
                label.classList.add("correct-answer");
            } else {
                label.classList.add("wrong-answer");
                document.getElementById(`lbl-${idx}-${q.a}`).classList.add("correct-answer");
                weakPoints.push(`Q${idx+1}`);
            }
            document.getElementById(`rat-${idx}`).style.display = "block";
        });

        if (!allAnswered) return alert("Please answer all questions before submitting.");

        const finalScore = Math.round((score / questions.length) * 100);
        document.getElementById("score-circle").innerText = finalScore + "%";
        document.getElementById("submit-btn").style.display = "none";

        const msgDiv = document.getElementById("result-message");
        if (finalScore >= 80) {
            msgDiv.innerHTML = `<div class="pass-text">PASSED</div>`;
        } else {
            msgDiv.innerHTML = `<div class="fail-text">NEEDS REVIEW</div>`;
        }

        // Send to Database
        const payload = {
            userName: user,
            moduleName: activeModule,
            score: finalScore,
            weakPoints: weakPoints.join(", ") || "None"
        };

        fetch(SCRIPT_URL, {
            method: "POST",
            mode: "no-cors",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
        }).then(() => console.log("Logged")).catch(err => console.error(err));

        setTimeout(() => switchView("results-view"), 1500);
    }

    function switchView(viewId) {
        document.querySelectorAll(".card").forEach(el => el.classList.add("hidden"));
        document.getElementById(viewId).classList.remove("hidden");
        window.scrollTo(0,0);
    }
</script>
</body>
</html>
